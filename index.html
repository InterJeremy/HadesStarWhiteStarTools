<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hades' Star White Star Tools</title>
  <style>
  html {
    overflow-y: scroll;
  }
    :root {
      --your-team-blue: #004080;
      --your-team-light-blue: #e1efff;
      --enemy-team-red: #ff6384;
      --enemy-team-light-red: #ffccd9;
      --button-bg: #f4f6fa;
      --button-bg-hover: #e0e3e8;
      --button-bg-active: #d1d5db;
      --button-border: #cfd8dc;
      --button-text: #222;
      --button-text-active: #004080;
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 960px;
      margin: 20px auto;
      padding: 0 15px;
      background: #f7f9fc;
      color: #222;
    }
    h1 {
      text-align: center;
      color: black;
      margin-bottom: 5px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-style: italic;
    }
    .tab-nav {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }
    button,
    .tab-btn {
      padding: 10px 24px;
      background: var(--button-bg);
      color: var(--button-text);
      border: 1.5px solid var(--button-border);
      border-radius: 999px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 1.5px 6px rgba(0,0,0,0.06);
      cursor: pointer;
      outline: none;
      transition: 
        background 0.18s,
        color 0.18s,
        border-color 0.18s,
        box-shadow 0.18s,
        transform 0.10s;
      appearance: none;
      user-select: none;
      margin: 0;
      display: inline-block;
    }
    button:disabled,
    .tab-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:hover,
    .tab-btn:hover {
      background: var(--button-bg-hover);
      border-color: #b0bec5;
      color: var(--button-text-active);
      box-shadow: 0 3px 12px rgba(0,0,0,0.10);
      transform: translateY(-1px) scale(1.02);
    }
    button:active,
    .tab-btn:active {
      background: var(--button-bg-active);
      border-color: #90a4ae;
      color: var(--button-text-active);
      box-shadow: 0 1.5px 6px rgba(0,0,0,0.06);
      transform: scale(0.98);
    }
    .tab-btn {
      border-radius: 18px 18px 0 0;
      border-bottom: none;
      background: var(--button-bg);
      color: var(--button-text);
      margin-bottom: -2px;
      position: relative;
      z-index: 1;
    }
    .tab-btn.active {
      background: #fff;
      color: var(--your-team-blue);
      border-bottom: 2.5px solid #fff;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
      z-index: 2;
    }
    .calculator-content {
      display: none;
      background: white;
      padding: 15px;
      border-radius: 32px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.28);
    }
    .calculator-content.active {
      display: block;
    }
    .team {
      background: white;
      padding: 15px 20px;
      border-radius: 32px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.28);
      flex: 1 1 440px;
    }
    #genrichChartContainer,
    #miningChartContainer {
      background: white;
      box-shadow: 0 6px 32px rgba(0,0,0,0.28);
      border-radius: 32px;
    }
    .results {
      padding: 12px;
      margin-top: 20px;
      border-radius: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
    }
    #yourTeam .results {
      background: var(--your-team-light-blue);
    }
    #enemyTeam .results {
      background: var(--enemy-team-light-red);
    }
    .team-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }
    #yourTeam h2 {
      color: var(--your-team-blue);
    }
    #enemyTeam h2 {
      color: #b22240;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 32px;
      overflow: hidden;
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
    }
    table tr:first-child th:first-child {
      border-top-left-radius: 32px;
    }
    table tr:first-child th:last-child {
      border-top-right-radius: 32px;
    }
    table tr:last-child td:first-child {
      border-bottom-left-radius: 32px;
    }
    table tr:last-child td:last-child {
      border-bottom-right-radius: 32px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
      background: white;
    }
    #yourTeam th {
      background: var(--your-team-light-blue);
      color: black;
    }
    #enemyTeam th {
      background: var(--enemy-team-light-red);
      color: black;
    }
    input[type="text"], input[type="number"] {
      width: 90%;
      padding: 4px 6px;
      font-size: 1rem;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      background: #f8fafc;
      transition: border-color 0.18s;
    }
    input[type="number"] {
      text-align: center;
    }
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--your-team-blue);
      outline: none;
      background: #fff;
    }
    .footer {
      text-align: center;
      font-size: 0.9rem;
      color: #666;
      margin-top: 40px;
    }
    #yourTeam .csv-upload,
    #modsTeam .csv-upload {
      margin: 10px 0;
      padding: 10px;
      background: var(--your-team-light-blue);
      border-radius: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 1rem;
    }
    #enemyTeam .csv-upload,
    .csv-upload:not(#yourTeam .csv-upload):not(#modsTeam .csv-upload) {
      margin: 10px 0;
      padding: 10px;
      background: var(--your-team-light-blue);
      border-radius: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 1rem;
    }
    .csv-upload label,
    .csv-upload .csv-file-label,
    .csv-upload small {
      font-size: 1rem;
      font-weight: 600;
      color: #222;
      margin-bottom: 0;
      margin-right: 0;
      display: inline-block;
      vertical-align: middle;
    }
    .csv-upload small {
      font-weight: 400;
      color: #666;
      margin-left: 0.5em;
    }
    .csv-upload input[type="file"] {
      display: none;
    }
    .csv-file-label {
      display: inline-block;
      padding: 10px 24px;
      background: var(--button-bg);
      color: var(--button-text);
      border: 1.5px solid var(--button-border);
      border-radius: 999px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 1.5px 6px rgba(0,0,0,0.06);
      cursor: pointer;
      outline: none;
      transition: 
        background 0.18s,
        color 0.18s,
        border-color 0.18s,
        box-shadow 0.18s,
        transform 0.10s;
      appearance: none;
      user-select: none;
      margin: 0;
      margin-right: 0.5em;
      vertical-align: middle;
    }
    .csv-file-label:hover {
      background: var(--button-bg-hover);
      border-color: #b0bec5;
      color: var(--button-text-active);
      box-shadow: 0 3px 12px rgba(0,0,0,0.10);
      transform: translateY(-1px) scale(1.02);
    }
    .csv-file-label:active {
      background: var(--button-bg-active);
      border-color: #90a4ae;
      color: var(--button-text-active);
      box-shadow: 0 1.5px 6px rgba(0,0,0,0.06);
      transform: scale(0.98);
    }
    .csv-upload .csv-file-name {
      font-size: 1rem;
      color: #666;
      margin-right: 0.5em;
      font-weight: 400;
      vertical-align: middle;
      display: inline-block;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .mining-speed-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
    }
    .mining-speed-item {
      font-weight: bold;
      white-space: nowrap;
    }
    .mining-speed-item span {
      font-weight: normal !important;
    }
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }
    .chart-container {
      flex: 1 1 400px;
      min-width: 0;
    }
    .chart-title {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .hydro-output {
      font-weight: bold;
    }
    .hydro-output span {
      font-weight: normal !important;
    }
    .results > div:first-child {
      font-weight: bold;
    }
    #yourTotal,
    #enemyTotal {
      font-weight: normal !important;
    }
    .total-label {
      font-weight: bold;
    }
    /* Mods Table styles */
    #modsTeam h2 {
      color: var(--your-team-blue);
    }
    .mods-table-group {
      margin-bottom: 32px;
      margin-top: 24px;
    }
    .mods-table-group h3 {
      margin-bottom: 8px;
      color: #222;
      text-align: left;
      font-size: 1.15rem;
      font-weight: bold;
      padding-left: 6px;
    }
    .mods-table {
      margin-bottom: 0;
      margin-top: 0;
      background: #fff;
      border-radius: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      min-width: 1200px;
    }
    .mods-table th {
      background: var(--your-team-light-blue);
      color: #222;
      font-weight: bold;
      font-size: 1rem;
      padding: 6px 8px;
    }
    .mods-table td {
      font-size: 1rem;
      padding: 6px 8px;
      color: #222;
    }
    .mods-table tr:first-child th:first-child {
      border-top-left-radius: 32px;
    }
    .mods-table tr:first-child th:last-child {
      border-top-right-radius: 32px;
    }
    .mods-table tr:last-child td:first-child {
      border-bottom-left-radius: 32px;
    }
    .mods-table tr:last-child td:last-child {
      border-bottom-right-radius: 32px;
    }
    @media (max-width: 700px) {
      .mods-table th, .mods-table td {
        font-size: 0.9rem;
        padding: 4px 4px;
      }
      .mods-table-group h3 {
        font-size: 1rem;
      }
    }
    .feedback-input {
    background: #f7f9fc;
    resize: none;
  }
  </style>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y2FG21YF1K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Y2FG21YF1K');
  </script>
  <!-- Chart.js and datalabels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- html2canvas for table image export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<h1>Hades' Star White Star Tools</h1>

<!-- Feedback Button (fixed at top right) -->
<button id="openFeedbackBtn" style="position:fixed;top:24px;right:32px;z-index:1001;">
  Feedback
</button>


<!-- Feedback Modal -->
<div id="feedback-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1000;justify-content:center;align-items:center;">
  <div style="background:#fff;border-radius:32px;box-shadow:0 6px 32px rgba(0,0,0,0.28);padding:24px 24px 16px 24px;min-width:340px;max-width:95vw;max-height:90vh;overflow:auto;position:relative;">
    <h2 style="color: var(--your-team-blue);margin-top:0;">Feedback</h2>
    <form
      id="feedbackForm"
      action="https://formspree.io/f/xovwwzva"
      method="POST"
      style="width:100%;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;"
    >
      <div id="feedback-error" style="color:#b22240;font-weight:bold;display:none;margin-bottom:8px;text-align:left;"></div>
      <label for="feedback-email" style="font-weight:600;text-align:left;display:block;margin-bottom:4px;">Your email (optional):</label>
      <input id="feedback-email" type="email" name="email" class="feedback-input" style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #cfd8dc;box-sizing:border-box;">
      <label for="feedback-message" style="font-weight:600;text-align:left;display:block;margin-top:10px;margin-bottom:4px;">Your message:</label>
      <textarea id="feedback-message" name="message" class="feedback-input" style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #cfd8dc;min-height:80px;box-sizing:border-box;"></textarea>
     <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
        <span style="color:#666;font-size:0.98rem;">
        This project is still under development.<br>
        Feedback and suggestions are welcome!
        </span>
        <button type="submit" class="download-btn">
          Send
        </button>
      </div>

    </form>
  </div>
</div>


<div class="tab-nav">
  <button class="tab-btn active" data-tab="genrich">Genrich Calculator</button>
  <button class="tab-btn" data-tab="mining">Mining Speed Calculator</button>
  <button class="tab-btn" data-tab="mods">Mods Tables</button>
</div>

<!-- Genrich Calculator -->
<div id="genrich-calculator" class="calculator-content active">
  <div class="team-container">
    <section class="team" id="yourTeam">
      <h2>Your Team</h2>
      <div class="csv-upload">
        <label class="csv-file-label" for="genrichCsvFile">Choose File</label>
        <input type="file" id="genrichCsvFile" accept=".csv" />
        <span class="csv-file-name" id="genrichCsvFileName">No file chosen</span>
        <button id="genrichLoadCsvBtn">Upload Team CSV</button>
        <small>(Upload CSV output from Compendium to auto-fill player data)</small>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Player Name</th>
            <th>Genesis Level (1-15)</th>
            <th>Enrich Level (1-15)</th>
          </tr>
        </thead>
        <tbody id="genrichYourTeamBody"></tbody>
      </table>
      <div class="results" id="yourHydroOutput">
        <div>Hydro Output:</div>
        <div class="hydro-output">
          P1: <span id="yourP1">0</span><br />
          P5: <span id="yourP5">0</span><br />
          P10: <span id="yourP10">0</span><br />
          Empty Sector: <span id="yourEmpty">0</span>
        </div>
      </div>
    </section>
    <section class="team" id="enemyTeam">
      <h2>Enemy Team</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Player Name</th>
            <th>Genesis Level (1-15)</th>
            <th>Enrich Level (1-15)</th>
          </tr>
        </thead>
        <tbody id="genrichEnemyTeamBody"></tbody>
      </table>
      <div class="results" id="enemyHydroOutput">
        <div>Hydro Output:</div>
        <div class="hydro-output">
          P1: <span id="enemyP1">0</span><br />
          P5: <span id="enemyP5">0</span><br />
          P10: <span id="enemyP10">0</span><br />
          Empty Sector: <span id="enemyEmpty">0</span>
        </div>
      </div>
    </section>
  </div>
  <div class="results" id="genrichChartContainer">
    <h2 style="text-align:center; color:black">Team Hydro Comparison</h2>
    <canvas id="genrichComparisonChart" width="600" height="300"></canvas>
    <div style="text-align:center; margin-top: 15px;">
      <button onclick="downloadGenrichChartImage()">Download Chart Image</button>
    </div>
  </div>
</div>

<!-- Mining Speed Calculator -->
<div id="mining-calculator" class="calculator-content">
  <div class="team-container">
    <section class="team" id="yourTeam">
      <h2>Your Team</h2>
      <div class="csv-upload">
        <label class="csv-file-label" for="miningCsvFile">Choose File</label>
        <input type="file" id="miningCsvFile" accept=".csv" />
        <span class="csv-file-name" id="miningCsvFileName">No file chosen</span>
        <button id="miningLoadCsvBtn">Upload Team CSV</button>
        <small>(Upload CSV output from Compendium to auto-fill player data)</small>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Player Name</th>
            <th>Miner (1-7)</th>
            <th>Mining Boost (1-15)</th>
            <th>Remote (1-15)</th>
            <th>HReplicator (1-15)</th>
          </tr>
        </thead>
        <tbody id="miningYourTeamBody"></tbody>
      </table>
      <div class="results" id="yourMiningOutput">
        <div>Mining Speed:</div>
        <div class="mining-speed-list" id="yourMiningSpeeds"></div>
        <div style="margin-top: 10px;"><span class="total-label">Total:</span> <span id="yourTotal">0</span></div>
      </div>
    </section>
    <section class="team" id="enemyTeam">
      <h2>Enemy Team</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Player Name</th>
            <th>Miner (1-7)</th>
            <th>Mining Boost (1-15)</th>
            <th>Remote (1-15)</th>
            <th>HReplicator (1-15)</th>
          </tr>
        </thead>
        <tbody id="miningEnemyTeamBody"></tbody>
      </table>
      <div class="results" id="enemyMiningOutput">
        <div>Mining Speed:</div>
        <div class="mining-speed-list" id="enemyMiningSpeeds"></div>
        <div style="margin-top: 10px;"><span class="total-label">Total:</span> <span id="enemyTotal">0</span></div>
      </div>
    </section>
  </div>
  <div class="results" id="miningChartContainer">
    <h2 style="text-align:center; color:black">Team Mining Speed Comparison</h2>
    <div class="chart-row">
      <div class="chart-container">
        <div class="chart-title" style="color: var(--your-team-blue);">Your Team</div>
        <canvas id="yourTeamChart" width="400" height="250"></canvas>
      </div>
      <div class="chart-container">
        <div class="chart-title" style="color: #b22240;">Enemy Team</div>
        <canvas id="enemyTeamChart" width="400" height="250"></canvas>
      </div>
    </div>
    <div class="download-buttons">
      <button onclick="downloadMiningChart('yourTeamChart', 'your_team_mining.png')">Download Your Team</button>
      <button onclick="downloadMiningChart('enemyTeamChart', 'enemy_team_mining.png')">Download Enemy Team</button>
      <button onclick="downloadBothMiningCharts()">Download Both Teams</button>
    </div>
  </div>
</div>

<!-- Mods Table -->
<div id="mods-table" class="calculator-content">
  <section class="team" id="modsTeam">
    <h2>Your Team</h2>
    <div class="csv-upload">
      <label class="csv-file-label" for="modsCsvFile">Choose File</label>
      <input type="file" id="modsCsvFile" accept=".csv" />
      <span class="csv-file-name" id="modsCsvFileName">No file chosen</span>
      <button id="modsLoadCsvBtn">Upload Team CSV</button>
      <small>(Upload CSV output from Compendium to auto-fill player data)</small>
    </div>
    <div id="modsTablesContainer"></div>
    <div class="download-buttons" id="modsDownloadButtons"></div>
  </section>
</div>







<div class="footer">
  Made for Hadesâ€™ Star White Star Genrich & Mining Speed Calculations.<br>
  Designed for desktop use. Not verified for mobile devices.
  <br>
  <!-- GitHub logo with link to repo -->
  <a href="https://github.com/InterJeremy/HadesStarWhiteStarTools" target="_blank" style="display:inline-block;margin-top:10px;">
    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/github.svg"
         alt="GitHub"
         style="width:32px;height:32px;vertical-align:middle;filter:grayscale(1);" />
  </a>
</div>

<script>
  // Tab Navigation
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active tab
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // Show selected calculator
      document.querySelectorAll('.calculator-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${btn.dataset.tab}-calculator`)?.classList.add('active');
      document.getElementById(`${btn.dataset.tab}-table`)?.classList.add('active');
    });
  });

  // Custom file input logic for all calculators
  function setupCustomFileInput(fileInputId, fileNameId) {
    const fileInput = document.getElementById(fileInputId);
    const fileNameSpan = document.getElementById(fileNameId);
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        fileNameSpan.textContent = fileInput.files[0].name;
      } else {
        fileNameSpan.textContent = 'No file chosen';
      }
    });
  }
  setupCustomFileInput('genrichCsvFile', 'genrichCsvFileName');
  setupCustomFileInput('miningCsvFile', 'miningCsvFileName');
  setupCustomFileInput('modsCsvFile', 'modsCsvFileName');

  // ======================
  // Genrich Calculator
  // ======================
  const genrichCalculator = {
    // ... (unchanged, see previous code)
    genesisData: {
      1: 60, 2: 70, 3: 80, 4: 90, 5: 100,
      6: 120, 7: 140, 8: 160, 9: 180, 10: 200,
      11: 240, 12: 280, 13: 320, 14: 400, 15: 500
    },
    enrichData: {
      1: 1.01, 2: 1.02, 3: 1.03, 4: 1.04, 5: 1.05,
      6: 1.06, 7: 1.08, 8: 1.10, 9: 1.12, 10: 1.16,
      11: 1.20, 12: 1.24, 13: 1.28, 14: 1.32, 15: 1.40
    },
    comparisonChart: null,
    saveToLocalStorage() {
      localStorage.setItem('genrichYourTeam', JSON.stringify(this.getTeamInputs('genrichYourTeamBody')));
      localStorage.setItem('genrichEnemyTeam', JSON.stringify(this.getTeamInputs('genrichEnemyTeamBody')));
    },
    loadFromLocalStorage() {
      const yourTeam = localStorage.getItem('genrichYourTeam');
      const enemyTeam = localStorage.getItem('genrichEnemyTeam');
      if (yourTeam) this.setTeamInputs('genrichYourTeamBody', JSON.parse(yourTeam));
      if (enemyTeam) this.setTeamInputs('genrichEnemyTeamBody', JSON.parse(enemyTeam));
    },
    getTeamInputs(containerId) {
      const tbody = document.getElementById(containerId);
      const nameInputs = tbody.querySelectorAll('input[type="text"]');
      const genesisInputs = tbody.querySelectorAll('input.genesis');
      const enrichInputs = tbody.querySelectorAll('input.enrich');
      const arr = [];
      for (let i = 0; i < 10; i++) {
        arr.push({
          name: nameInputs[i].value,
          genesis: genesisInputs[i].value,
          enrich: enrichInputs[i].value
        });
      }
      return arr;
    },
    setTeamInputs(containerId, arr) {
      const tbody = document.getElementById(containerId);
      const nameInputs = tbody.querySelectorAll('input[type="text"]');
      const genesisInputs = tbody.querySelectorAll('input.genesis');
      const enrichInputs = tbody.querySelectorAll('input.enrich');
      for (let i = 0; i < 10; i++) {
        if (arr[i]) {
          nameInputs[i].value = arr[i].name || '';
          genesisInputs[i].value = arr[i].genesis || '1';
          enrichInputs[i].value = arr[i].enrich || '1';
        }
      }
    },
    init() {
      this.buildTeamRows('genrichYourTeamBody');
      this.buildTeamRows('genrichEnemyTeamBody');
      this.loadFromLocalStorage();
      ['genrichYourTeamBody', 'genrichEnemyTeamBody'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          this.updateAll();
          this.saveToLocalStorage();
        });
      });
      document.getElementById('genrichLoadCsvBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('genrichCsvFile');
        if (!fileInput.files.length) {
          alert('Please select a CSV file first');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          this.processCSV(e.target.result);
          this.saveToLocalStorage();
        };
        reader.readAsText(fileInput.files[0]);
      });
      this.updateAll();
    },
    buildTeamRows(containerId) {
      const tbody = document.getElementById(containerId);
      tbody.innerHTML = '';
      for(let i = 1; i <= 10; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i}</td>
          <td><input type="text" placeholder="Player ${i}" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="genesis" min="1" max="15" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="enrich" min="1" max="15" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
        `;
        tbody.appendChild(tr);
      }
    },
    calculateHydro(teamId) {
      const tbody = document.getElementById(teamId + 'Body');
      const genesisInputs = tbody.querySelectorAll('input.genesis');
      const enrichInputs = tbody.querySelectorAll('input.enrich');
      const genesisLevels = [], enrichLevels = [];
      for (let i = 0; i < 10; i++) {
        let g = Number(genesisInputs[i].value);
        let e = Number(enrichInputs[i].value);
        g = Math.min(Math.max(g, 1), 15);
        e = Math.min(Math.max(e, 1), 15);
        genesisLevels.push(g);
        enrichLevels.push(e);
      }
      const top7Genesis = genesisLevels.slice().sort((a, b) => b - a).slice(0, 7);
      const genesisSum = top7Genesis.reduce((sum, g) => sum + (this.genesisData[g] || 0), 0);
      const enrichProduct = enrichLevels.reduce((prod, e) => prod * (this.enrichData[e] || 1), 1);
      const P1 = genesisSum * enrichProduct * 2;
      const P5 = genesisSum * enrichProduct * 3;
      const P10 = genesisSum * enrichProduct * 6;
      const Empty = genesisSum * enrichProduct;
      return { P1, P5, P10, Empty };
    },
    renderComparisonChart(yourData, enemyData) {
      const ctx = document.getElementById('genrichComparisonChart').getContext('2d');
      const labels = ['P1', 'P5', 'P10', 'Empty Sector'];
      const data = {
        labels: labels,
        datasets: [
          {
            label: 'Your Team',
            data: [yourData.P1, yourData.P5, yourData.P10, yourData.Empty],
            backgroundColor: '#e1efff',
            borderColor: '#004080',
            borderWidth: 1
          },
          {
            label: 'Enemy Team',
            data: [enemyData.P1, enemyData.P5, enemyData.P10, enemyData.Empty],
            backgroundColor: '#ffccd9',
            borderColor: '#b22240',
            borderWidth: 1
          }
        ]
      };
      const config = {
        type: 'bar',
        data: data,
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#222' }
            },
            datalabels: {
              anchor: 'end',
              align: 'right',
              color: '#222',
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value) {
                return value.toFixed(0);
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: '#222'
              },
              grid: {
                color: '#eee'
              }
            },
            y: {
              ticks: {
                color: '#222'
              },
              grid: {
                color: '#eee'
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      };
      if (this.comparisonChart) {
        this.comparisonChart.destroy();
      }
      this.comparisonChart = new Chart(ctx, config);
    },
    processCSV(csvData) {
      if (csvData.charCodeAt(0) === 0xFEFF) {
        csvData = csvData.substring(1);
      }
      const lines = csvData.split(/\r?\n/).map(line => line.trim()).filter(line => line !== '');
      const headerIndex = lines.findIndex(line => line.includes('DiscordTag,Name'));
      if (headerIndex === -1) {
        alert('Error: Could not find header row in CSV');
        return;
      }
      const dataLines = lines.slice(headerIndex + 1).slice(0, 10);
      const nameInputs = document.querySelectorAll('#genrichYourTeamBody input[type="text"]');
      const genesisInputs = document.querySelectorAll('#genrichYourTeamBody input.genesis');
      const enrichInputs = document.querySelectorAll('#genrichYourTeamBody input.enrich');
      nameInputs.forEach(input => input.value = '');
      genesisInputs.forEach(input => input.value = '1');
      enrichInputs.forEach(input => input.value = '1');
      dataLines.forEach((line, i) => {
        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const name = parts[1]?.trim() || '';
        const genesis = parseInt(parts[24]) || 1;
        const enrich = parseInt(parts[25]) || 1;
        nameInputs[i].value = name;
        genesisInputs[i].value = Math.max(1, Math.min(15, genesis));
        enrichInputs[i].value = Math.max(1, Math.min(15, enrich));
      });
      this.updateAll();
    },
    updateAll() {
      const yourHydro = this.calculateHydro('genrichYourTeam');
      const enemyHydro = this.calculateHydro('genrichEnemyTeam');
      document.getElementById('yourP1').textContent = yourHydro.P1.toFixed(0);
      document.getElementById('yourP5').textContent = yourHydro.P5.toFixed(0);
      document.getElementById('yourP10').textContent = yourHydro.P10.toFixed(0);
      document.getElementById('yourEmpty').textContent = yourHydro.Empty.toFixed(0);
      document.getElementById('enemyP1').textContent = enemyHydro.P1.toFixed(0);
      document.getElementById('enemyP5').textContent = enemyHydro.P5.toFixed(0);
      document.getElementById('enemyP10').textContent = enemyHydro.P10.toFixed(0);
      document.getElementById('enemyEmpty').textContent = enemyHydro.Empty.toFixed(0);
      this.renderComparisonChart(yourHydro, enemyHydro);
    }
  };

  // ======================
  // Mining Speed Calculator
  // ======================
  const miningCalculator = {
    // ... (unchanged, see previous code)
    minerData: {
      1: 20.0, 2: 24.0, 3: 30.0, 4: 40.0, 5: 50.0, 6: 54.5, 7: 60.0
    },
    miningBoostData: {
      1: 1.05, 2: 1.10, 3: 1.20, 4: 1.30, 5: 1.40,
      6: 1.50, 7: 1.60, 8: 1.80, 9: 2.00, 10: 2.20,
      11: 2.40, 12: 2.60, 13: 2.80, 14: 3.10, 15: 3.50
    },
    remoteMiningData: {
      1: 2, 2: 3, 3: 4, 4: 5, 5: 6,
      6: 7, 7: 8, 8: 9, 9: 10, 10: 11,
      11: 12, 12: 13, 13: 14, 14: 16, 15: 20
    },
    hydroReplicatorData: {
      1: 1.04, 2: 1.08, 3: 1.12, 4: 1.16, 5: 1.20,
      6: 1.25, 7: 1.30, 8: 1.35, 9: 1.40, 10: 1.45,
      11: 1.50, 12: 1.60, 13: 1.70, 14: 1.80, 15: 2.00
    },
    playerColors: [
      '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
      '#FF9F40', '#8AC24A', '#F06292', '#7986CB', '#A1887F'
    ],
    yourTeamChart: null,
    enemyTeamChart: null,
    saveToLocalStorage() {
      localStorage.setItem('miningYourTeam', JSON.stringify(this.getTeamInputs('miningYourTeamBody')));
      localStorage.setItem('miningEnemyTeam', JSON.stringify(this.getTeamInputs('miningEnemyTeamBody')));
    },
    loadFromLocalStorage() {
      const yourTeam = localStorage.getItem('miningYourTeam');
      const enemyTeam = localStorage.getItem('miningEnemyTeam');
      if (yourTeam) this.setTeamInputs('miningYourTeamBody', JSON.parse(yourTeam));
      if (enemyTeam) this.setTeamInputs('miningEnemyTeamBody', JSON.parse(enemyTeam));
    },
    getTeamInputs(containerId) {
      const tbody = document.getElementById(containerId);
      const nameInputs = tbody.querySelectorAll('input[type="text"]');
      const minerInputs = tbody.querySelectorAll('input.miner');
      const miningBoostInputs = tbody.querySelectorAll('input.miningboost');
      const remoteInputs = tbody.querySelectorAll('input.remote');
      const hreplicatorInputs = tbody.querySelectorAll('input.hreplicator');
      const arr = [];
      for (let i = 0; i < 10; i++) {
        arr.push({
          name: nameInputs[i].value,
          miner: minerInputs[i].value,
          miningboost: miningBoostInputs[i].value,
          remote: remoteInputs[i].value,
          hreplicator: hreplicatorInputs[i].value
        });
      }
      return arr;
    },
    setTeamInputs(containerId, arr) {
      const tbody = document.getElementById(containerId);
      const nameInputs = tbody.querySelectorAll('input[type="text"]');
      const minerInputs = tbody.querySelectorAll('input.miner');
      const miningBoostInputs = tbody.querySelectorAll('input.miningboost');
      const remoteInputs = tbody.querySelectorAll('input.remote');
      const hreplicatorInputs = tbody.querySelectorAll('input.hreplicator');
      for (let i = 0; i < 10; i++) {
        if (arr[i]) {
          nameInputs[i].value = arr[i].name || '';
          minerInputs[i].value = arr[i].miner || '1';
          miningBoostInputs[i].value = arr[i].miningboost || '1';
          remoteInputs[i].value = arr[i].remote || '1';
          hreplicatorInputs[i].value = arr[i].hreplicator || '1';
        }
      }
    },
    init() {
      this.buildTeamRows('miningYourTeamBody');
      this.buildTeamRows('miningEnemyTeamBody');
      this.loadFromLocalStorage();
      ['miningYourTeamBody', 'miningEnemyTeamBody'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          this.updateAll();
          this.saveToLocalStorage();
        });
      });
      document.getElementById('miningLoadCsvBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('miningCsvFile');
        if (!fileInput.files.length) {
          alert('Please select a CSV file first');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          this.processCSV(e.target.result);
          this.saveToLocalStorage();
        };
        reader.readAsText(fileInput.files[0]);
      });
      this.updateAll();
    },
    buildTeamRows(containerId) {
      const tbody = document.getElementById(containerId);
      tbody.innerHTML = '';
      for(let i = 1; i <= 10; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i}</td>
          <td><input type="text" placeholder="Player ${i}" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="miner" min="1" max="7" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="miningboost" min="1" max="15" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="remote" min="1" max="15" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
          <td><input type="number" class="hreplicator" min="1" max="15" value="1" data-team="${containerId}" data-index="${i-1}" /></td>
        `;
        tbody.appendChild(tr);
      }
    },
    calculateMiningSpeed(teamId) {
      const tbody = document.getElementById(teamId + 'Body');
      const nameInputs = tbody.querySelectorAll('input[type="text"]');
      const minerInputs = tbody.querySelectorAll('input.miner');
      const miningBoostInputs = tbody.querySelectorAll('input.miningboost');
      const remoteInputs = tbody.querySelectorAll('input.remote');
      const hreplicatorInputs = tbody.querySelectorAll('input.hreplicator');
      const playerData = [];
      let totalSpeed = 0;
      for (let i = 0; i < 10; i++) {
        const name = nameInputs[i].value || `Player ${i+1}`;
        let miner = Math.min(Math.max(Number(minerInputs[i].value), 1), 7);
        let miningboost = Math.min(Math.max(Number(miningBoostInputs[i].value), 1), 15);
        let remote = Math.min(Math.max(Number(remoteInputs[i].value), 1), 15);
        let hreplicator = Math.min(Math.max(Number(hreplicatorInputs[i].value), 1), 15);
        const speed = 0.5 * (this.minerData[miner] || 20.0) * 
                     (this.remoteMiningData[remote] || 2) * 
                     ((this.miningBoostData[miningboost] || 1.0) + 1) * 
                     (this.hydroReplicatorData[hreplicator] || 1.0);
        playerData.push({
          name: name,
          speed: speed,
          roundedSpeed: Math.round(speed),
          miner: miner,
          miningboost: miningboost,
          remote: remote,
          hreplicator: hreplicator
        });
        totalSpeed += speed;
      }
      return {
        players: playerData,
        total: Math.round(totalSpeed)
      };
    },
    updatePlayerSpeedDisplay(teamId, data) {
      const container = document.getElementById(teamId + 'MiningSpeeds');
      const totalElement = document.getElementById(teamId + 'Total');
      container.innerHTML = '';
      data.players.forEach(player => {
        const item = document.createElement('div');
        item.className = 'mining-speed-item';
        item.innerHTML = `${player.name}: <span>${player.roundedSpeed}</span>`;
        container.appendChild(item);
      });
      totalElement.textContent = data.total;
    },
    createChartConfig(data, teamName, borderColor) {
      return {
        type: 'bar',
        data: {
          labels: [teamName],
          datasets: data.players.map((player, i) => ({
            label: player.name,
            data: [player.speed],
            backgroundColor: this.playerColors[i],
            borderColor: borderColor,
            borderWidth: 1,
            roundedSpeed: player.roundedSpeed
          }))
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: () => '',
                label: (context) => {
                  const player = data.players[context.datasetIndex];
                  return `${player.name}: ${player.roundedSpeed}`;
                },
                afterLabel: (context) => {
                  const player = data.players[context.datasetIndex];
                  return [
                    `Miner: ${player.miner}`,
                    `Mining Boost: ${player.miningboost}`,
                    `Remote: ${player.remote}`,
                    `HReplicator: ${player.hreplicator}`
                  ].join('\n');
                }
              }
            },
            datalabels: {
              color: '#000',
              font: {
                size: 9,
                weight: 'bold'
              },
              formatter: (value, context) => {
                return data.players[context.datasetIndex].roundedSpeed;
              },
              anchor: 'center',
              align: 'center',
              display: (context) => {
                return context.dataset.data[context.dataIndex] > 50;
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: '#222'
              },
              grid: {
                color: '#eee'
              },
              title: {
                display: true,
                text: 'Mining Speed',
                color: '#222'
              }
            },
            y: {
              stacked: true,
              ticks: {
                color: '#222'
              },
              grid: {
                color: '#eee'
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      };
    },
    renderCharts(yourData, enemyData) {
      if (this.yourTeamChart) this.yourTeamChart.destroy();
      if (this.enemyTeamChart) this.enemyTeamChart.destroy();
      const yourCtx = document.getElementById('yourTeamChart').getContext('2d');
      this.yourTeamChart = new Chart(yourCtx, this.createChartConfig(yourData, 'Your Team', '#004080'));
      const enemyCtx = document.getElementById('enemyTeamChart').getContext('2d');
      this.enemyTeamChart = new Chart(enemyCtx, this.createChartConfig(enemyData, 'Enemy Team', '#ff6384'));
    },
    processCSV(csvData) {
      if (csvData.charCodeAt(0) === 0xFEFF) {
        csvData = csvData.substring(1);
      }
      const lines = csvData.split(/\r?\n/).map(line => line.trim()).filter(line => line !== '');
      const headerIndex = lines.findIndex(line => line.includes('DiscordTag,Name'));
      if (headerIndex === -1) {
        alert('Error: Could not find header row in CSV');
        return;
      }
      const dataLines = lines.slice(headerIndex + 1).slice(0, 10);
      const nameInputs = document.querySelectorAll('#miningYourTeamBody input[type="text"]');
      const minerInputs = document.querySelectorAll('#miningYourTeamBody input.miner');
      const miningBoostInputs = document.querySelectorAll('#miningYourTeamBody input.miningboost');
      const remoteInputs = document.querySelectorAll('#miningYourTeamBody input.remote');
      const hreplicatorInputs = document.querySelectorAll('#miningYourTeamBody input.hreplicator');
      nameInputs.forEach(input => input.value = '');
      minerInputs.forEach(input => input.value = '1');
      miningBoostInputs.forEach(input => input.value = '1');
      remoteInputs.forEach(input => input.value = '1');
      hreplicatorInputs.forEach(input => input.value = '1');
      dataLines.forEach((line, i) => {
        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const name = parts[1]?.trim() || '';
        const miner = parseInt(parts[7]) || 1;
        const miningboost = parseInt(parts[20]) || 1;
        const remote = parseInt(parts[23]) || 1;
        const hreplicator = parseInt(parts[21]) || 1;
        nameInputs[i].value = name;
        minerInputs[i].value = Math.max(1, Math.min(7, miner));
        miningBoostInputs[i].value = Math.max(1, Math.min(15, miningboost));
        remoteInputs[i].value = Math.max(1, Math.min(15, remote));
        hreplicatorInputs[i].value = Math.max(1, Math.min(15, hreplicator));
      });
      this.updateAll();
    },
    updateAll() {
      const yourData = this.calculateMiningSpeed('miningYourTeam');
      const enemyData = this.calculateMiningSpeed('miningEnemyTeam');
      this.updatePlayerSpeedDisplay('your', yourData);
      this.updatePlayerSpeedDisplay('enemy', enemyData);
      this.renderCharts(yourData, enemyData);
    }
  };

  // ======================
  // Mods Table
  // ======================
  const modsTable = {
    // Define mod groups and their fields
    groups: [
      {
        name: "Ships",
        fields: ["transp", "miner", "bs"]
      },
      {
        name: "Transport",
        fields: ["cargobay", "computer", "remoterepair", "rush", "stealth", "tradeburst", "shipdrone", "rsextender", "relicdrone", "dispatch", "cargorocket"]
      },
      {
        name: "Mining",
        fields: ["miningboost", "hydroreplicator", "artifactboost", "remote", "genesis", "enrich", "crunch", "hydroupload", "hydrorocket", "blastdrone"]
      },
      {
        name: "Weapon",
        fields: ["laser", "mass", "battery", "dual", "barrage", "dart", "chainray", "rocketlauncher", "pulse"]
      },
      {
        name: "Shield",
        fields: ["alpha", "delta", "passive", "omega", "blast", "mirror", "area", "motionshield"]
      },
      {
        name: "Combat",
        fields: ["emp", "solitude", "fortify", "teleport", "damageamplifier", "destiny", "barrier", "vengeance", "deltarocket", "leap", "bond", "suspend", "omegarocket", "remotebomb"]
      },
      {
        name: "Drone",
        fields: ["decoydrone", "repairdrone", "rocketdrone", "laserturret", "chainrayturret", "deltadrone", "dronesquad"]
      }
    ],
    // Store parsed data
    players: [],
    // Store header mapping
    headerMap: {},
    // Save to localStorage
    saveToLocalStorage() {
      localStorage.setItem('modsTablePlayers', JSON.stringify(this.players));
    },
    // Load from localStorage
    loadFromLocalStorage() {
      const data = localStorage.getItem('modsTablePlayers');
      if (data) {
        this.players = JSON.parse(data);
        this.renderTables();
      }
    },
    // Parse CSV and update players
    processCSV(csvData) {
      if (csvData.charCodeAt(0) === 0xFEFF) {
        csvData = csvData.substring(1);
      }
      const lines = csvData.split(/\r?\n/).map(line => line.trim()).filter(line => line !== '');
      const headerIndex = lines.findIndex(line => line.includes('DiscordTag,Name'));
      if (headerIndex === -1) {
        alert('Error: Could not find header row in CSV');
        return;
      }
      const headerLine = lines[headerIndex];
      const headers = headerLine.split(',');
      // Build header map: field name -> index
      this.headerMap = {};
      headers.forEach((h, idx) => {
        this.headerMap[h.trim().toLowerCase()] = idx;
      });
      // Get up to 10 player lines
      const dataLines = lines.slice(headerIndex + 1).slice(0, 10);
      this.players = [];
      dataLines.forEach(line => {
        const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        // Player name: use Name field (index 1)
        let name = (parts[this.headerMap["name"]] || "").trim();
        if (!name) {
           name = (parts[this.headerMap["discordtag"]] || "").trim();
        }
        // For each group, for each field, get value (or empty string)
        const mods = {};
        this.groups.forEach(group => {
          group.fields.forEach(field => {
            const idx = this.headerMap[field];
            let val = (typeof idx !== "undefined" && parts[idx] !== undefined) ? parts[idx].trim() : "";
            mods[field] = val;
          });
        });
        this.players.push({ name, mods });
      });
      this.saveToLocalStorage();
      this.renderTables();
    },
    // Render all group tables
    renderTables() {
      const container = document.getElementById('modsTablesContainer');
      container.innerHTML = '';
      if (!this.players.length) return;
      // Store table DOM references for download
      this.tableRefs = [];
      this.groups.forEach((group, groupIdx) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'mods-table-group';
        // Group title
        const h3 = document.createElement('h3');
        h3.textContent = group.name;
        groupDiv.appendChild(h3);
        // Table
        const table = document.createElement('table');
        table.className = 'mods-table';
        // Table header
        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');
        const thName = document.createElement('th');
        thName.textContent = 'Player Name';
        trHead.appendChild(thName);
        group.fields.forEach(field => {
          const th = document.createElement('th');
          th.textContent = field;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);
        // Table body
        const tbody = document.createElement('tbody');
        this.players.forEach(player => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          tdName.textContent = player.name;
          tr.appendChild(tdName);
          group.fields.forEach(field => {
            const td = document.createElement('td');
            td.textContent = player.mods[field] || '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        // Wrap table in scrollable div
        const scrollDiv = document.createElement('div');
        scrollDiv.style.overflowX = 'auto';
        scrollDiv.style.width = '100%';
        // For download, wrap table and title in a container
        const tableContainer = document.createElement('div');
        tableContainer.style.display = 'inline-block';
        tableContainer.style.background = '#fff';
        tableContainer.style.borderRadius = '32px';
        tableContainer.style.boxShadow = '0 2px 12px rgba(0,0,0,0.10)';
        tableContainer.style.padding = '16px 8px 8px 8px';
        tableContainer.style.margin = '0 auto';
        tableContainer.style.textAlign = 'center';
        // Title for download (hidden visually, but included in image)
        const downloadTitle = document.createElement('div');
        downloadTitle.textContent = group.name;
        downloadTitle.style.fontWeight = 'bold';
        downloadTitle.style.fontSize = '1.15rem';
        downloadTitle.style.color = '#222';
        downloadTitle.style.marginBottom = '8px';
        downloadTitle.style.textAlign = 'center';
        tableContainer.appendChild(downloadTitle);
        tableContainer.appendChild(table.cloneNode(true));
        // Store for download
        this.tableRefs[groupIdx] = { table, title: group.name, container: tableContainer };
        scrollDiv.appendChild(table);
        groupDiv.appendChild(scrollDiv);
        container.appendChild(groupDiv);
      });
      // Render download buttons
      this.renderDownloadButtons();
    },
    // Render download buttons for each table
    renderDownloadButtons() {
      const btnsDiv = document.getElementById('modsDownloadButtons');
      btnsDiv.innerHTML = '';
      if (!this.tableRefs || !this.tableRefs.length) return;
      this.tableRefs.forEach((ref, idx) => {
        const btn = document.createElement('button');
        btn.textContent = `Download ${ref.title}`;
        btn.style.margin = '0 6px 0 0';
        btn.onclick = () => downloadModsTableAsImage(idx);
        btnsDiv.appendChild(btn);
      });
    },
    // Init mods table
    init() {
      this.loadFromLocalStorage();
      document.getElementById('modsLoadCsvBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('modsCsvFile');
        if (!fileInput.files.length) {
          alert('Please select a CSV file first');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          this.processCSV(e.target.result);
        };
        reader.readAsText(fileInput.files[0]);
      });
    }
  };

  // ======================
  // Download Functions
  // ======================
  function downloadGenrichChartImage() {
    const canvas = document.getElementById('genrichComparisonChart');
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    ctx.drawImage(canvas, 0, 0);
    const link = document.createElement('a');
    link.download = 'team_hydro_comparison.png';
    link.href = tempCanvas.toDataURL('image/png', 1.0);
    link.click();
  }
  function downloadMiningChart(canvasId, filename) {
    const canvas = document.getElementById(canvasId);
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    ctx.drawImage(canvas, 0, 0);
    const link = document.createElement('a');
    link.download = filename;
    link.href = tempCanvas.toDataURL('image/png', 1.0);
    link.click();
  }
  function downloadBothMiningCharts() {
    const yourCanvas = document.getElementById('yourTeamChart');
    const enemyCanvas = document.getElementById('enemyTeamChart');
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');
    tempCanvas.width = Math.max(yourCanvas.width, enemyCanvas.width);
    tempCanvas.height = yourCanvas.height + enemyCanvas.height + 40;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    ctx.drawImage(yourCanvas, 0, 0);
    ctx.drawImage(enemyCanvas, 0, yourCanvas.height + 20);
    const link = document.createElement('a');
    link.download = 'both_teams_mining_comparison.png';
    link.href = tempCanvas.toDataURL('image/png', 1.0);
    link.click();
  }

  // Download a mods table as PNG (only the table, no title)
  function downloadModsTableAsImage(idx) {
    // Get the table DOM node directly from the page
    const table = document.querySelectorAll('.mods-table')[idx];
    if (!table) return;
    // Use html2canvas to render the table as image
    html2canvas(table, {
      backgroundColor: "#fff",
      scale: 2,
      useCORS: true,
      scrollX: 0,
      scrollY: 0,
      windowWidth: table.scrollWidth,
      windowHeight: table.scrollHeight
    }).then(canvas => {
      // Create a download link and trigger download
      const link = document.createElement('a');
      // Use group name as filename
      const groupName = modsTable.groups[idx]?.name || 'mods_table';
      link.download = `${groupName.replace(/\s+/g, '_').toLowerCase()}_mods.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    });
  }

  // Initialize all calculators when page loads
  window.onload = () => {
    genrichCalculator.init();
    miningCalculator.init();
    modsTable.init();
  };

// Feedback modal logic
document.addEventListener('DOMContentLoaded', function() {
  const openBtn = document.getElementById('openFeedbackBtn');
  const modal = document.getElementById('feedback-modal');
  if (openBtn && modal) {
    openBtn.addEventListener('click', () => {
      // Detect if body has vertical scrollbar
      const hasScrollbar = document.body.scrollHeight > window.innerHeight;
      if (hasScrollbar) {
        document.body.style.paddingRight = '17px'; // typical scrollbar width
      }
      document.body.style.overflow = 'hidden';
      modal.style.display = 'flex';
    });
  }
  // Click outside modal content to close
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    });
  }
});

// Custom feedback form validation
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('feedbackForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      const message = form.querySelector('textarea[name="message"]').value.trim();
      const errorDiv = document.getElementById('feedback-error');
      if (!message) {
        e.preventDefault();
        errorDiv.textContent = "Please enter your feedback message.";
        errorDiv.style.display = "block";
        form.querySelector('textarea[name="message"]').focus();
      } else {
        errorDiv.style.display = "none";
      }
    });
  }
});


</script>

</body>
</html>
